name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      backup_file:
        description: 'Backup file to restore (leave empty to select latest)'
        required: false
        type: string
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true
        type: string

env:
  APP_DIR: /var/www/fleetbackend
  DEPLOY_USER: fleet

jobs:
  validate:
    name: Validate Rollback Request
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "ROLLBACK" ]; then
            echo "‚ùå Confirmation failed. You must type 'ROLLBACK' to proceed."
            exit 1
          fi
          echo "‚úÖ Rollback confirmed"

      - name: Log rollback details
        run: |
          echo "üîÑ Rollback initiated"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date)"
          echo "Backup file: ${{ github.event.inputs.backup_file || 'Latest available' }}"

  rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://fleetmanager.co.zw

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          command_timeout: 30m
          script: |
            set -e

            cd ${{ env.APP_DIR }}

            echo "üîÑ Starting rollback process..."
            echo "Triggered by: ${{ github.actor }}"
            echo "Time: $(date)"
            echo ""

            # List available backups
            echo "üì¶ Available backups:"
            if [ -d "backups" ]; then
              ls -lht backups/db_backup_*.sql.gz | head -n 5 || echo "No backups found"
            else
              echo "‚ùå Backup directory not found!"
              exit 1
            fi
            echo ""

            # Determine backup file
            BACKUP_FILE="${{ github.event.inputs.backup_file }}"
            if [ -z "$BACKUP_FILE" ]; then
              # Use the latest backup
              BACKUP_FILE=$(ls -t backups/db_backup_*.sql.gz 2>/dev/null | head -n 1)
              if [ -z "$BACKUP_FILE" ]; then
                echo "‚ùå No backup files found!"
                exit 1
              fi
              echo "üì• Using latest backup: $(basename $BACKUP_FILE)"
            else
              if [ ! -f "$BACKUP_FILE" ]; then
                echo "‚ùå Specified backup file not found: $BACKUP_FILE"
                exit 1
              fi
              echo "üì• Using specified backup: $(basename $BACKUP_FILE)"
            fi
            echo ""

            # Create a pre-rollback backup
            echo "üíæ Creating pre-rollback backup..."
            mkdir -p backups
            PRE_ROLLBACK_BACKUP="backups/pre_rollback_$(date +'%Y%m%d_%H%M%S').sql"

            if [ -f .env ]; then
              DB_URL=$(grep DATABASE_URL .env | cut -d '=' -f2- | tr -d '"' | tr -d "'")

              if [[ $DB_URL =~ postgresql://([^:]+):([^@]+)@([^:]+):([^/]+)/(.+) ]]; then
                PGPASSWORD="${BASH_REMATCH[2]}" pg_dump \
                  -h "${BASH_REMATCH[3]}" \
                  -p "${BASH_REMATCH[4]}" \
                  -U "${BASH_REMATCH[1]}" \
                  -d "${BASH_REMATCH[5]}" \
                  > "$PRE_ROLLBACK_BACKUP" 2>/dev/null || echo "‚ö†Ô∏è Pre-rollback backup failed"

                if [ -f "$PRE_ROLLBACK_BACKUP" ]; then
                  gzip "$PRE_ROLLBACK_BACKUP"
                  echo "‚úÖ Pre-rollback backup created: ${PRE_ROLLBACK_BACKUP}.gz"
                fi
              fi
            fi
            echo ""

            # Restore database
            echo "üóÑÔ∏è  Restoring database from backup..."
            DB_URL=$(grep DATABASE_URL .env | cut -d '=' -f2- | tr -d '"' | tr -d "'")

            if [[ $DB_URL =~ postgresql://([^:]+):([^@]+)@([^:]+):([^/]+)/(.+) ]]; then
              DB_USER="${BASH_REMATCH[1]}"
              DB_PASS="${BASH_REMATCH[2]}"
              DB_HOST="${BASH_REMATCH[3]}"
              DB_PORT="${BASH_REMATCH[4]}"
              DB_NAME="${BASH_REMATCH[5]}"

              # Decompress backup
              TEMP_SQL="/tmp/restore_$(date +%s).sql"
              gunzip -c "$BACKUP_FILE" > "$TEMP_SQL"

              # Restore database
              if PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" < "$TEMP_SQL"; then
                echo "‚úÖ Database restored successfully"
                rm "$TEMP_SQL"
              else
                echo "‚ùå Database restore failed!"
                rm "$TEMP_SQL"
                exit 1
              fi
            else
              echo "‚ùå Could not parse DATABASE_URL"
              exit 1
            fi
            echo ""

            # Restart application
            echo "‚ôªÔ∏è  Restarting application..."
            pm2 restart ecosystem.config.js --env production
            pm2 save
            echo "‚úÖ Application restarted"
            echo ""

            # Verify application health
            echo "üè• Verifying application health..."
            for i in {1..10}; do
              sleep 3
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Application is healthy after rollback!"
                echo ""
                echo "üéâ Rollback completed successfully!"
                exit 0
              fi
              echo "Attempt $i/10: Waiting for application..."
            done

            echo "‚ùå Application health check failed after rollback!"
            echo "Pre-rollback backup available at: ${PRE_ROLLBACK_BACKUP}.gz"
            exit 1

      - name: Notify rollback success
        if: success()
        run: |
          echo "‚úÖ Rollback completed successfully!"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date)"

      - name: Notify rollback failure
        if: failure()
        run: |
          echo "‚ùå Rollback failed!"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date)"
          echo "Please check the logs and consider manual intervention."

name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Navigate to application directory
            cd /var/www/fleetbackend

            # Pull latest changes
            echo "üì¶ Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/main

            # Install dependencies
            echo "üìö Installing dependencies..."
            npm ci --legacy-peer-deps

            # Generate Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate

            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            npx prisma migrate deploy || echo "‚ö†Ô∏è  No migrations to run or migration failed"

            # Check migration status
            echo "üìä Checking migration status..."
            npx prisma migrate status || echo "Migration status check completed"

            # Build application
            echo "üèóÔ∏è  Building application..."
            npm run build

            # Restart PM2
            echo "‚ôªÔ∏è  Restarting application..."
            pm2 restart ecosystem.config.js --env production

            # Save PM2 configuration
            pm2 save

            # Check application status
            echo "‚úÖ Checking application status..."
            pm2 status

            # Test application health
            sleep 3
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful! Application is running."
            else
              echo "‚ö†Ô∏è  Application may not be responding correctly. Check logs with: pm2 logs fleetbackend"
            fi

            echo "üéâ Deployment completed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

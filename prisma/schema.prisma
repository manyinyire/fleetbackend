// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CENTRAL TABLES (No tenant scoping)
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  email     String
  phone     String?
  status    TenantStatus @default(ACTIVE)
  plan      SubscriptionPlan @default(FREE)
  monthlyRevenue Decimal @db.Decimal(10, 2) @default(0)
  suspendedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Billing fields
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  autoRenew            Boolean @default(true)

  // Relationships
  users     User[]
  vehicles  Vehicle[]
  drivers   Driver[]
  settings  TenantSettings?
  invoices  Invoice[]
  invoiceReminders InvoiceReminder[]

  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  emailVerified Boolean  @default(false)
  image         String?
  role          UserRole @default(USER)
  tenantId      String?  // null for super_admin
  password      String?  // Hashed password for email/password auth
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 2FA fields
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Relationships
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions  Session[]
  accounts  Account[]
  auditLogs AuditLog[]

  // Email verification
  emailVerifications EmailVerification[]

  // Admin relationships
  adminSettings AdminSettings?
  adminSessions AdminSession[]
  adminIpWhitelist AdminIpWhitelist[]

  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  FLEET_MANAGER
  ACCOUNTANT
  DRIVER
  USER
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Account {
  id                    String   @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?  // Hashed password for email/password auth
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ============================================
// TENANT-SCOPED TABLES (Include tenantId)
// ============================================

model Vehicle {
  id                 String   @id @default(cuid())
  tenantId           String   // MANDATORY for RLS
  registrationNumber String
  make               String
  model              String
  year               Int
  type               VehicleType
  initialCost        Decimal  @db.Decimal(10, 2)
  currentMileage     Int      @default(0)
  status             VehicleStatus @default(ACTIVE)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relationships
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  drivers            DriverVehicleAssignment[]
  remittances        Remittance[]
  maintenanceRecords MaintenanceRecord[]
  expenses           Expense[]
  incomes            Income[]

  @@unique([tenantId, registrationNumber]) // Unique per tenant
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@map("vehicles")
}

enum VehicleType {
  CAR
  OMNIBUS
  BIKE
}

enum VehicleStatus {
  ACTIVE
  UNDER_MAINTENANCE
  DECOMMISSIONED
}

model Driver {
  id                String   @id @default(cuid())
  tenantId          String   // MANDATORY for RLS
  fullName          String
  nationalId        String
  licenseNumber     String
  phone             String
  email             String?
  homeAddress       String
  nextOfKin         String
  nextOfKinPhone    String
  // Defensive license for commuter omnibus
  hasDefensiveLicense Boolean @default(false)
  defensiveLicenseNumber String?
  defensiveLicenseExpiry DateTime?
  paymentModel      PaymentModel
  paymentConfig     Json     // Stores model-specific config
  debtBalance       Decimal  @db.Decimal(10, 2) @default(0)
  status            DriverStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles          DriverVehicleAssignment[]
  remittances       Remittance[]
  contracts         Contract[]

  @@unique([tenantId, nationalId])
  @@index([tenantId, status])
  @@map("drivers")
}

enum PaymentModel {
  OWNER_PAYS        // Model A: Percentage-based
  DRIVER_REMITS     // Model B: Fixed target
  HYBRID            // Model C: Base + performance
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

model DriverVehicleAssignment {
  id          String   @id @default(cuid())
  tenantId    String   // MANDATORY for RLS
  driverId    String
  vehicleId   String
  isPrimary   Boolean  @default(true)
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime @default(now())

  // Relationships
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([driverId, vehicleId, startDate])
  @@index([tenantId])
  @@index([vehicleId, endDate]) // Index for efficient querying of active assignments
  @@map("driver_vehicle_assignments")
}

model Remittance {
  id            String   @id @default(cuid())
  tenantId      String   // MANDATORY for RLS
  driverId      String
  vehicleId     String
  amount        Decimal  @db.Decimal(10, 2)
  date          DateTime
  status        RemittanceStatus @default(PENDING)
  proofOfPayment String? // S3 URL
  notes         String?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, date])
  @@index([driverId])
  @@index([vehicleId])
  @@map("remittances")
}

enum RemittanceStatus {
  PENDING
  APPROVED
  REJECTED
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  tenantId    String   // MANDATORY for RLS
  vehicleId   String
  date        DateTime
  mileage     Int
  type        MaintenanceType
  description String
  cost        Decimal  @db.Decimal(10, 2)
  provider    String
  invoice     String?  // S3 URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([vehicleId])
  @@index([date])
  @@map("maintenance_records")
}

enum MaintenanceType {
  ROUTINE_SERVICE
  TIRE_REPLACEMENT
  BRAKE_SERVICE
  ENGINE_REPAIR
  ELECTRICAL
  BODY_WORK
  OTHER
}

model Contract {
  id            String   @id @default(cuid())
  tenantId      String   // MANDATORY for RLS
  driverId      String
  contractNumber String  @unique
  status        ContractStatus @default(DRAFT)
  signedAt      DateTime?
  signatureData String?  // Base64 signature
  pdfUrl        String?  // S3 URL of signed PDF
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([driverId])
  @@map("contracts")
}

enum ContractStatus {
  DRAFT
  ACTIVE
  TERMINATED
}

model Expense {
  id          String   @id @default(cuid())
  tenantId    String   // MANDATORY for RLS
  vehicleId   String?
  category    ExpenseCategory
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime
  description String
  receipt     String?  // S3 URL
  status      ExpenseStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime @default(now())

  // Relationships
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, date])
  @@map("expenses")
}

enum ExpenseCategory {
  FUEL
  MAINTENANCE
  INSURANCE
  LICENSE
  SALARY
  ADMINISTRATIVE
  LOAN_PAYMENT
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

model Income {
  id          String   @id @default(cuid())
  tenantId    String   // MANDATORY for RLS
  vehicleId   String?
  source      IncomeSource
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime
  description String?
  createdAt   DateTime @default(now())

  // Relationships
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, source])
  @@index([tenantId, date])
  @@map("incomes")
}

enum IncomeSource {
  REMITTANCE
  OTHER
}

model TenantSettings {
  id              String   @id @default(cuid())
  tenantId        String   @unique // MANDATORY for RLS
  
  // Branding
  companyName     String
  logoUrl         String?  // S3 URL
  primaryColor    String   @default("#1e3a8a")
  
  // Contact Information
  email           String
  phone           String
  address         String?
  city            String?
  country         String   @default("Zimbabwe")
  
  // Invoice Settings
  invoicePrefix   String   @default("INV")
  invoiceFooter   String?
  taxNumber       String?
  bankDetails     String?  // JSON with bank account info
  
  // Notification Settings
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  
  // Business Settings
  currency        String   @default("USD")
  timezone        String   @default("Africa/Harare")
  dateFormat      String   @default("YYYY-MM-DD")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_settings")
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?  // null for system-wide actions
  userId      String
  action      String
  entityType  String
  entityId    String?
  oldValues   Json?
  newValues   Json?
  details     Json?
  ipAddress   String
  userAgent   String
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SUPER ADMIN TABLES
// ============================================

model AdminSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // 2FA Settings
  twoFactorEnabled      Boolean  @default(false)
  twoFactorSecret       String?
  
  // IP Whitelist
  ipWhitelistEnabled    Boolean  @default(false)
  
  // Session Management
  maxConcurrentSessions Int      @default(2)
  sessionTimeout        Int      @default(30) // minutes
  
  // Security Settings
  requirePasswordChange Boolean  @default(false)
  passwordChangeDays    Int      @default(90)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_settings")
}

model AdminSession {
  id            String   @id @default(cuid())
  userId        String
  ipAddress     String
  userAgent     String
  expiresAt     DateTime
  rememberDevice Boolean @default(false)
  createdAt     DateTime @default(now())

  // Relationships
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model AdminIpWhitelist {
  id          String   @id @default(cuid())
  userId      String
  ipAddress   String
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relationships
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("admin_ip_whitelist")
}

model AdminSecurityLog {
  id        String   @id @default(cuid())
  eventType String
  data      Json
  timestamp DateTime @default(now())

  @@index([eventType])
  @@index([timestamp])
  @@map("admin_security_logs")
}

model SystemAlert {
  id          String   @id @default(cuid())
  type        AlertType
  severity    AlertSeverity
  title       String
  message     String
  data        Json?
  acknowledged Boolean @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolved    Boolean @default(false)
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([acknowledged])
  @@map("system_alerts")
}

enum AlertType {
  SYSTEM_HEALTH
  SECURITY
  PERFORMANCE
  BILLING
  USER_ACTIVITY
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
  SUCCESS
}

model PlatformMetrics {
  id          String   @id @default(cuid())
  metricName  String
  metricValue Decimal  @db.Decimal(15, 4)
  metadata    Json?
  timestamp   DateTime @default(now())

  @@index([metricName])
  @@index([timestamp])
  @@map("platform_metrics")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  type        EmailType
  subject     String
  body        String
  variables   Json?    // Available template variables
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

enum EmailType {
  WELCOME
  PASSWORD_RESET
  INVOICE_NOTIFICATION
  SUBSCRIPTION_RENEWAL
  PAYMENT_FAILED
  TRIAL_EXPIRING
  ACCOUNT_SUSPENDED
  ADMIN_NOTIFICATION
}

model FeatureFlag {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isEnabled   Boolean  @default(false)
  rolloutPercentage Int @default(0) // 0-100
  targetTenants Json?  // Array of tenant IDs or conditions
  environments Json?   // Array of environments (prod, staging, dev)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isEnabled])
  @@map("feature_flags")
}

// ============================================
// EMAIL AND VERIFICATION TABLES
// ============================================

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  type      VerificationType
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

enum VerificationType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
}

model OTP {
  id        String   @id @default(cuid())
  userId    String
  code      String
  type      OTPType
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("otps")
}

enum OTPType {
  TWO_FACTOR
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

// ============================================
// INVOICE AND BILLING TABLES
// ============================================

model Invoice {
  id              String   @id @default(cuid())
  tenantId        String
  invoiceNumber   String   @unique
  type            InvoiceType
  status          InvoiceStatus @default(PENDING)
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  dueDate         DateTime
  paidAt          DateTime?
  plan            SubscriptionPlan
  billingPeriod   String?  // e.g., "2024-01-01 to 2024-01-31"
  description     String?
  pdfUrl          String?  // S3 URL for generated PDF
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reminders       InvoiceReminder[]

  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@index([type])
  @@map("invoices")
}

enum InvoiceType {
  SUBSCRIPTION
  UPGRADE
  RENEWAL
  OVERAGE
  CUSTOM
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model InvoiceReminder {
  id          String   @id @default(cuid())
  invoiceId   String
  tenantId    String
  sentAt      DateTime
  type        ReminderType
  createdAt   DateTime @default(now())

  // Relationships
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId])
  @@index([sentAt])
  @@map("invoice_reminders")
}

enum ReminderType {
  SEVEN_DAYS
  THREE_DAYS
  ONE_DAY
  OVERDUE
}